<!DOCTYPE html>

<html lang="en" xmlns:th="https://www.thymleaf.org">
<head>
    <div th:replace="~{fragments/fragment :: page_head('Sushi','none')}"></div>
</head>
<body>
<div th:replace="~{fragments/navbars :: user_navbar}"></div>
    <div class="row m-1">
        <div class="col-sm-8">
            <th:block th:each="item, status :${cartItems}">
                <div class="row border rounded">
                    <div class="col-1">
                        <div>[[${status.count}]]</div>
                        <div>
                            <a class="fa-solid fa-trash-can linkRemove" th:href="@{'/cart/remove/'+${item.product.id}}" style="color: #282828"></a>
                        </div>
                    </div>
                    <div class="col-3">
                        <img th:src="@{${item.product.mainImagePath}}" class="img-fluid">
                    </div>
                    <div class="col-6">
                        <div>
                            <p><b>[[${item.product.name}]]</b></p>
                        </div>
                        <div th:replace="~{fragments/fragment :: quantity_control(${item.quantity},${item.product.id})}"></div>
                        <div>
                            <div>
                                <div>
                                    <span>X&nbsp; $[[${item.product.price}]]</span>
                                </div>
                                <div>
                                    <span>=&nbsp;$</span>
                                    <span class="h4 subtotal" th:id="'subtotal' +${item.product.id}">[[${item.subtotal}]]</span>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="row m-1">&nbsp;</div>
            </th:block>
        </div>
        <div class="col-sm-4" th:unless="${cartItems.isEmpty()}">
            <div> <span class="h3">Итого</span></div>
            <div class="mt-2">
                <span class="h3" id="total"> $[[${estimatedTotal}]]</span>
            </div>
            <div class="mt-2">
                <button class="btn btn-danger">Оплатить</button>
            </div>
        </div>
        <div class="row m-1" th:if="${cartItems.isEmpty()}">
            <span class="h3">Корзина пуста</span>
        </div>
    </div>
    <div class="modal fade text-center" id="modalDialog" role="alertdialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="modalTitle">Предупреждение</h4>
                    <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
                </div>

                <div class="modal-body">
                    <span id="modalBody"></span>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>
<script>
    contextPath = "[[@{/}]]"
    let csrfHeaderName='[[${_csrf.headerName}]]';
    let csrfValue='[[${_csrf.token}]]';
    const modal=new bootstrap.Modal("#modalDialog")
    $(document).ready(function() {

        $(".linkMinus").on("click", function(evt) {
            evt.preventDefault($(this));
            decreaseQuantity($(this))
        });
        $(".linkPlus").on("click", function(evt) {
            evt.preventDefault($(this));
            increaseQuantity($(this))
        });
        $(".linkRemove").on("click", function(evt) {
            evt.preventDefault($(this));
            removeProduct($(this))

        });
    });
    function decreaseQuantity(link){
        productId = link.attr("pid");
        quantityInput = $("#quantity" + productId);
        newQuantity = parseInt(quantityInput.val()) - 1;
        if (newQuantity > 0) {
            quantityInput.val(newQuantity);
            updateQuantity(productId,newQuantity)
        } else {
            $("#modalBody").html("Минимальное количество 1")
            modal.show();
        }
    }
    function increaseQuantity(link){
        productId = link.attr("pid");
        quantityInput = $("#quantity" + productId);
        newQuantity = parseInt(quantityInput.val()) + 1;
        if (newQuantity <= 10) {
            quantityInput.val(newQuantity);
            updateQuantity(productId,newQuantity)
        } else {
            $("#modalBody").html("Максимальное количество 10")
            modal.show();
        }
    }
    function updateQuantity(productId,quantity){
        url= contextPath+"cart/update/"+productId+"/"+quantity;
        $.ajax({
            type: "POST",
            url:url,
            beforeSend: function(xhr){
                xhr.setRequestHeader(csrfHeaderName,csrfValue);
            }
        }).done(function (updatedSubtotal){

            updateSubtotal(updatedSubtotal,productId)
            updateTotal();
        }).fail(function (){
            $("#modalBody").html("Произошла ошибка во время дабавления товара в корзину")
            modal.show();
        });
    }
    function updateSubtotal(updatedSubtotal,productId){
        $("#subtotal"+productId).html(updatedSubtotal)
    }
    function updateTotal(){
        total=0.0
        $(".subtotal").each(function (i, element) {
            total += parseFloat(element.innerHTML);
        });
        $("#total").text("$"+total);
    }
    function removeProduct(link) {
        url=link.attr("href")
        $.ajax({
            type: "DELETE",
            url:url,
            beforeSend: function(xhr){
                xhr.setRequestHeader(csrfHeaderName,csrfValue);
            }
        }).done(function (response){
            alert(response)
        }).fail(function (){
            $("#modalBody").html("Произошла ошибка во время удалила товара в корзину")
            modal.show();
        });
    }
</script>
</body>
</html>